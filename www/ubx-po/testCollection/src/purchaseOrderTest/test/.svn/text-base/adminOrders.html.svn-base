<?xml version="1.0"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ev="http://www.w3.org/2001/xml-events" 
      xmlns:xforms="http://www.w3.org/2002/xforms" 
      xmlns:xsd="http://www.w3.org/2001/XMLSchema"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-Instance"
	  xmlns:javascript="http://www.w3.org/2002/xforms#inline">
 <head>
    <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type" />
    <meta name="AUTHOR" content="Erik A. Johnson" />
    <title>Purchase Order Application XForm</title>    
    <script src="../../src/ubiquity-loader.js" type="text/javascript">/**/</script>

    <script src="format.js" type="text/javascript">/**/</script>
	<link href="./style/mainStyle.css" rel="stylesheet"></link>
	<link href="./style/gen_default.css" rel="stylesheet"></link>
	
  </head>
  <body class="yui-skin-sam">
       <xforms:model id="model">  
           <!-- Main inventory listing retreived from the eXist database  -->
           <xforms:instance id='Orders' src="http://localhost:8080/exist/rest/db/testCollection/ordersList.xml"></xforms:instance>
           <xforms:submission id="updateOrders" 
                              method="put" 
                              includenamespaceprefixes=""
                              action="http://localhost:8080/exist/rest/db/testCollection/ordersList.xml">
                <xforms:message ev:event="xforms-submit-error" level="modal" if="event('error-type')!='validation-error'">Unable to submit. Please try again later.</xforms:message>
                <xforms:message ev:event="xforms-submit-error" level="modal" if="event('error-type')='validation-error'">Some of the data on this form is invalid. Please correct errors and try again.</xforms:message>
           </xforms:submission>
           
            <!-- The total is just the sum of the subtotal and the tax; any time
                  those change, the total is automatically updated -->
           <xforms:bind nodeset="/ordersList/order/total" calculate="../subtotal + ../tax"></xforms:bind>
           	                 
           <!-- The tax is just the subtotal times the tax rate -->
           <xforms:bind nodeset="/ordersList/order/tax" calculate="../subtotal * 0.07"></xforms:bind>
           
           <!-- The node set feature of XPath is used to get all the line total 
                  elements and set a calculation for each one.  A line total is
                  just the unit cost times the quantity.  Any time a new row is 
                  inserted, this declaration automatically creates a new line total
                  calculation for it.  An update of unit cost or quantity on any row 
                  automatically updates the line total of that row, which then causes
                  the subtotal, tax and total to be updated automatically.  Even though
                  those calculations are declared before this one, XForms reorders the 
                  calculations so that they run in the order that makes sense. -->
           <xforms:bind nodeset="/ordersList/order/product/lineTotal" calculate="../cost * ../quantity"></xforms:bind>
             
           
           <!-- The subtotal is the sum of all the line totals.  Any time a row is
                  inserted, deleted or changed, the subtotal is automatically updated.
                  The calculate uses the 'node set' feature of XPath to get however
                  many line total elements exist for the summation. -->
           <xforms:bind nodeset="/ordersList/order/subtotal" calculate="sum(../product/lineTotal)"></xforms:bind>
           

           <!-- Once a purchase item is created, the user must specify a quantity. -->
          <xforms:bind nodeset="/ordersList/order/product/quantity" type="xsd:positiveInteger"></xforms:bind>
          	
           
           <!-- Once a purchase item is created, the user must choose a product name. -->
           <xforms:bind nodeset="/ordersList/order/product" required="true()"></xforms:bind>
         
           
           
           
           
           
           
           
           
           
       </xforms:model>
       <xforms:model id="prototypeModel">
         <xforms:instance id="prototype" src="http://localhost:8080/exist/rest/db/testCollection/orderPrototype.xml"></xforms:instance>
         
         </xforms:model>

<div id="mainContainer">

<div id="headerContainer">
  
 
 </div> <!-- header div-->
 
 <div id="mainContentArea">
	 <div id="leftNavigation">
	 <ul>
	 <li>
	 <xforms:trigger appearance="xf:image">
	 	<img class="buttonImage" src="../pngIcons/Shopping Cart.png" />
	 	<xforms:label>Orders</xforms:label>
	 </xforms:trigger>
      </li>
      <li>
    
    <xforms:trigger appearance="xf:image">
    		<img class="buttonImage" src="../pngIcons/Door.png" />
        	<xforms:label>Inventory</xforms:label>
        	<xforms:load ev:event="DOMActivate" resource="adminInventory.html"/>
        </xforms:trigger>
      </li>
      <li>
    
    <xforms:trigger appearance="xf:image">
    	<img class="buttonImage" src="../pngIcons/logout.png" />
        <xforms:label>Logout</xforms:label>
        <xforms:load ev:event="DOMActivate" resource="purchaseOrderMain.html"/>
    </xforms:trigger>
    </li>
    </ul>
		
	</div>
 
 <div id="mainForm">
 <br/>
 <h3>Current Orders</h3>
 <hr class="rule"/>
 <br/>
 <br/> 
 <xforms:repeat instance="Orders" nodeset="/ordersList/order" id="ordersTable">
 	<xforms:output>
 		<img class="buttonImage" src="../pngIcons/User.png" />
 		<xforms:label ref="customer/customerName"></xforms:label>
 	</xforms:output>
 	<hr/>
         <xforms:repeat nodeset="productsList/product" id="productListings">
         	<xforms:trigger appearance="xf:image">
			<img class="buttonImage" src="../pngIcons/Delete.png" />
			<xforms:label></xforms:label>
			<xforms:action ev:event="DOMActivate">
			       <!-- Delete the currently indexed item -->
			       <xforms:delete nodeset="../product" at="index('productListings')"></xforms:delete> 
			       <!-- Put the focus to the indexed item of the order table -->
			       <xforms:setfocus control="productListings"></xforms:setfocus>
			</xforms:action>
		</xforms:trigger>
	      <xforms:input ref="productName">
		<xforms:label>Name:</xforms:label>
	      </xforms:input>
	      <xforms:input ref="cost">
		<xforms:label>Cost:</xforms:label>
	      </xforms:input>
	      <xforms:input ref="quantity">
		<xforms:label>Quantitiy:</xforms:label>
	      </xforms:input>
		
	</xforms:repeat>
	<hr/>
	<xforms:output ref="subTotal" class="table_summary regular">
		<xforms:label>Subtotal:</xforms:label>
	</xforms:output >
	<xforms:output ref="tax" class="table_summary regular">
		<xforms:label>Tax:</xforms:label>
	</xforms:output>
	<xforms:output ref="total" class="table_summary regular">
		<xforms:label>Total:</xforms:label>
	</xforms:output>
	
</xforms:repeat>
	<xforms:submit submission="updateOrders" appearance="xf:image">
		<img class="buttonImage" src="../pngIcons/save2.png" />
        <xforms:label>Save</xforms:label>
    </xforms:submit>
     
  <xforms:trigger appearance="xf:image">
    	<img class="buttonImage" src="../pngIcons/Add2.png" />
        <xforms:label>Add</xforms:label>
        <xforms:action ev:event="DOMActivate">
        
           <!-- Insert a new item after the currently indexed item
                (the last focused item before this trigger was activated) -->
           <xforms:insert  context="/ordersList" nodeset="order" at="index('ordersTable')" 
                          position="after"  origin="/ordersList/prototype/order"></xforms:insert>
        
           <!-- Send the focus to the new item in the order table -->
           <xforms:setfocus control="ordersTable"></xforms:setfocus>
        
        </xforms:action> 
    </xforms:trigger>
  
    </div><!-- mainForm-->
    
    
    </div><!-- main content area-->
<div id="footerContainer">
</div> <!-- footer div-->
   
</div> <!--Main container div-->
    

    
   </body>
</html>
